#!/usr/bin/env bash
#
# Copyright 2016 Christopher Antila

case $1 in
    "init"|"initialize")
        source {{ ansible_venv_dir }}/bin/activate
        ansible-playbook -i .inventory .ansible.yml
        ansible-playbook -i .inventory .initialize.yml
    ;;

    "reset")
        printf "Resetting 'hgdemo' test MEI repository to a known-good state.\n\n"
        source {{ ansible_venv_dir }}/bin/activate
        cd {{ repo_directory }}/hgdemo
        hg update -C {{ hgdemo_clean_revision_hash }}
    ;;

    "run")
        case $2 in
            "http")
                echo "Starting Julius via web server"
                exec {{ julius_http_start_script }}
            ;;
            *)
                echo "Starting Julius in Electron"
                exec {{ julius_electron_start_script }}
            ;;
        esac
    ;;

    "test")
        case $2 in
            "julius")
                echo "Running the Julius test suite"
                cd {{ repo_directory }}/julius
                {{ npm_path }} test
            ;;
            "fujian")
                echo "Running the Fujian test suite"
                source {{ lychee_venv_dir }}/bin/activate
                py.test {{ repo_directory }}/fujian
            ;;
            "lychee")
                echo "Running the Lychee test suite"
                source {{ lychee_venv_dir }}/bin/activate
                py.test {{ repo_directory }}/lychee
            ;;
            "mercurial-hug")
                echo "Running the Mercurial-Hug test suite"
                source {{ lychee_venv_dir }}/bin/activate
                py.test {{ repo_directory }}/mercurial-hug
            ;;
            *)
                echo "Running all the test suites"
                cd {{ repo_directory }}/julius
                {{ npm_path }} test
                cd {{ repository_root }}
                source {{ lychee_venv_dir }}/bin/activate
                py.test {{ repo_directory }}/fujian
                py.test {{ repo_directory }}/lychee
                py.test {{ repo_directory }}/mercurial-hug
            ;;
        esac
    ;;

    "update"|"upgrade"|"sync")
        case $2 in
            "julius")
                echo "Updating Julius's dependencies"
                source {{ ansible_venv_dir }}/bin/activate
                ansible-playbook -i .inventory .initialize.yml -t update_julius
            ;;
            "lychee")
                echo "Updating Lychee's dependencies"
                source {{ ansible_venv_dir }}/bin/activate
                ansible-playbook -i .inventory .initialize.yml -t update_lychee
            ;;
            "ncoda"|"nc")
                echo "Updating the 'nc' program (that's me!)"
                source {{ ansible_venv_dir }}/bin/activate
                ansible-playbook -i .inventory .initialize.yml -t update_ncoda
            ;;
            *)
                echo "Updating all dependencies"
                source {{ ansible_venv_dir }}/bin/activate
                ansible-playbook -i .inventory .initialize.yml -t update
            ;;
        esac
    ;;

    *)
printf "nc: program does this

Copyright 2016 Christopher Antila

Commands:
---------
- init                    Bootstrap the nCoda development environment.
  initialize
- run [electron|http]     Start Fujian/Lychee and Julius, either with
                          'electron' (the default) or a web server.
- test [julius|lychee|fujian|mercurial-hug]  Run an automated test suite.
- update [julius|lychee|nc|all] (default 'all') Update, upgrade, or
  upgrade                 synchronize dependencies for these softwares.
  sync
\n"
;;
esac
